<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crop Image</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            background-color: #f0f0f0;
        }
        #image-container {
            position: relative;
            max-width: 100%;
            max-height: 80vh;
            border: 1px solid #ddd;
            background-color: #fff;
        }
        #image-container img {
            max-width: 100%;
            max-height: 100%;
        }
        #selection {
            position: absolute;
            border: 2px dashed #000;
            cursor: move;
        }
        #buttons {
            margin-top: 10px;
        }
    </style>
    <script>
        let startX, startY, selection, image, container;
        let isSelecting = false;

        window.onload = function() {
            image = document.getElementById('image');
            container = document.getElementById('image-container');
            selection = document.getElementById('selection');
            
            image.addEventListener('mousedown', startSelection);
            document.addEventListener('mousemove', updateSelection);
            document.addEventListener('mouseup', endSelection);
        }

        function startSelection(event) {
            isSelecting = true;
            const rect = container.getBoundingClientRect();
            startX = event.clientX - rect.left;
            startY = event.clientY - rect.top;

            selection.style.left = startX + 'px';
            selection.style.top = startY + 'px';
            selection.style.width = '0px';
            selection.style.height = '0px';
            selection.style.display = 'block';
        }

        function updateSelection(event) {
            if (!isSelecting) return;

            const rect = container.getBoundingClientRect();
            let currentX = event.clientX - rect.left;
            let currentY = event.clientY - rect.top;

            let width = Math.abs(currentX - startX);
            let height = Math.abs(currentY - startY);

            selection.style.width = width + 'px';
            selection.style.height = height + 'px';

            if (currentX < startX) {
                selection.style.left = currentX + 'px';
            }
            if (currentY < startY) {
                selection.style.top = currentY + 'px';
            }
        }

        function endSelection() {
            isSelecting = false;
        }

        function submitCrop() {
            const rect = selection.getBoundingClientRect();
            const imgRect = container.getBoundingClientRect();

            const x = rect.left - imgRect.left;
            const y = rect.top - imgRect.top;
            const width = rect.width;
            const height = rect.height;

            if (width > 0 && height > 0) {
                const form = document.getElementById('cropForm');
                form.elements['x'].value = x;
                form.elements['y'].value = y;
                form.elements['width'].value = width;
                form.elements['height'].value = height;
                form.submit();
            } else {
                alert("Please select a valid region to crop.");
            }
        }

        function cancelCrop() {
            window.location.href = '/';
        }
    </script>
</head>
<body>
    <div id="image-container">
        <img id="image" src="{{ image }}" alt="Image to Crop">
        <div id="selection"></div>
    </div>
    <div id="buttons">
        <form id="cropForm" action="/process_crop" method="post" style="display: inline;">
            <input type="hidden" name="x">
            <input type="hidden" name="y">
            <input type="hidden" name="width">
            <input type="hidden" name="height">
            <button type="button" onclick="submitCrop()">确认框选</button>
        </form>
        <button type="button" onclick="cancelCrop()">取消操作</button>
    </div>
</body>
</html>
